<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Delta Chat+ | PWA</title>

<meta name="theme-color" content="#0b0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" id="manifest-placeholder">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e50914">
<style>
  :root {
    --bg-dark: #0b0f1a;
    --bg-panel: #111827;
    --primary: #22c55e;
    --primary-dim: #15803d;
    --accent: #2563eb;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --glass: rgba(255, 255, 255, 0.05);
  }

  * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

  body {
    margin: 0;
    background: var(--bg-dark);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    justify-content: center;
    overflow: hidden; /* Prevent body scroll, handle in containers */
  }

  /* --- AUTH SCREEN --- */
  #auth {
    display: flex;
    flex-direction: column;
    justify-content: center;margin-left: 35%;
    gap: 15px;
    padding: 70px;
    background: var(--glass);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    width: 120%;
    max-width: 350px;
    align-self: center;
  }
  #auth h2 { margin: 0 0 10px 0; text-align: center; color: var(--primary); }
  #auth input {
    padding: 12px;
    background: rgba(0,0,0,0.3);
    border: 1px solid #374151;
    color: white;
    border-radius: 8px;
    outline: none;
  }
  #auth button {
    padding: 12px;
    background: var(--primary);
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  #auth button:hover { opacity: 0.9; transform: translateY(-1px); }

  /* --- MAIN APP LAYOUT --- */
  #app {
    display: none; /* Hidden until logged in */
    width: 100% !important;
    max-width: 1400px;
    height: 100%;
    background: var(--bg-panel);
    display: flex;
    overflow: hidden;
    position: relative;
  }

  /* SIDEBAR */
  .sidebar {
    width: 280px;
    background: rgba(0,0,0,0.2);
    border-right: 1px solid #1f2937;
    display: flex;
    flex-direction: column;
    padding: 15px;
    gap: 15px;
  }
  .logo { font-size: 1.2rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
  
  .section-title { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; margin-bottom: 5px; }
  
  .room-btn, .user-btn {
    padding: 10px;
    border-radius: 8px;
    background: transparent;
    color: var(--text-muted);
    border: none;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.2s;
  }
  .room-btn:hover, .user-btn:hover { background: rgba(255,255,255,0.05); color: white; }
  .room-btn.active, .user-btn.active { background: var(--primary); color: black; font-weight: bold; }

  /* Online Status Dot */
  .online-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4b5563; /* Offline grey */
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
  }
  .online-dot.online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }

  /* CHAT AREA */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    background-image: radial-gradient(circle at 50% 50%, #1a2332 1px, transparent 1px);
    background-size: 20px 20px;
  }

  .chat-header {
    padding: 15px;
    border-bottom: 1px solid #1f2937;
    background: rgba(17, 24, 39, 0.9);
    backdrop-filter: blur(5px);
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    scroll-behavior: smooth;
  }

  /* MESSAGE BUBBLES */
  .msg {
    max-width: 75%;
    width: fit-content;
    padding: 10px 14px;
    border-radius: 18px;
    background: #1f2937;
    color: #e5e7eb;
    position: relative;
    font-size: 0.95rem;
    line-height: 1.4;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  
  .msg.me {
    background: linear-gradient(135deg, var(--primary), var(--primary-dim));
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .msg.them { border-bottom-left-radius: 4px; }
  
  .msg-sender { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2px; display: block; }
  .msg.me .msg-sender { display: none; } /* Don't show name for self */

  .msg img { max-width: 100%; border-radius: 12px; margin-top: 5px; cursor: pointer; }

  /* METADATA (Time & Ticks) */
  .metadata {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    margin-top: 2px;
    font-size: 0.7rem;
    opacity: 0.7;
  }
  .tick { font-size: 0.8rem; }
  .tick.seen { color: #81e6d9; text-shadow: 0 0 5px rgba(129, 230, 217, 0.5); } /* Glowing Blue tick */

  /* REACTIONS */
  .reaction-bar {
    position: absolute;
    bottom: -15px;
    right: 0;
    background: #2d3748;
    border-radius: 12px;
    padding: 2px 6px;
    display: flex;
    gap: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    font-size: 0.8rem;
    border: 1px solid #4b5563;
    z-index: 2;
    
  }
  .reaction-picker {
    position: absolute;
    top: -15px;
    right: -80px;
    background: #1f2937;
    border: 1px solid #374151;
    padding: 5px;
    border-radius: 20px;
    display: none; /* Hidden by default */
    gap: 5px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    z-index: 100;
  }
  .msg:hover .reaction-picker { display: flex; animation: fadeIn 0.2s; }
  .emoji-btn { cursor: pointer; transition: transform 0.2s; padding: 2px; }
  .emoji-btn:hover { transform: scale(1.3); }

  /* INPUT AREA */
  .input-area {
    padding: 15px;
    background: #111827;
    display: flex;
    gap: 10px;
    align-items: center;
    border-top: 1px solid #1f2937;
  }
  #messageInput {
    flex: 1;
    padding: 12px 15px;
    border-radius: 24px;
    border: 1px solid #374151;
    background: #1f2937;
    color: white;
    outline: none;
  }
  #messageInput:focus { border-color: var(--primary); }
  .icon-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: 0.2s !important;
  }
  .icon-btn:hover { background: rgba(34, 197, 94, 0.1); }

  /* MOBILE RESPONSIVE */
  @media (max-width: 768px) {
    #app { flex-direction: column; }
  
    .section-title, .logo { display: none; } /* Compact view */
    .chat-area { height: calc(100% - 60px); }
    .msg { max-width: 85%; }
  }
  
  /* UTILITIES */
  .hidden { display: none !important; }
  #typingIndicator { font-size: 0.8rem; color: var(--primary); margin-left: 10px; height: 15px; }











 :root {
    --bg-dark: #0b0f1a;
    --bg-panel: #111827;
    --primary: #22c55e;
    --primary-glow: rgba(34, 197, 94, 0.3);
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --sidebar-w: 280px;
  }

  * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }

  /* --- APP STRUCTURE --- */
  #app { display: none; height: 100vh; width: 100vw; position: relative; }

  /* --- SIDEBAR (RESPONSIVE) --- */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: var(--sidebar-w);
    background: #0f172a;
    border-right: 1px solid #1e293b;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Mobile Sidebar Toggle Logic */
  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); height: 100%;}
    .sidebar.open { transform: translateX(0); box-shadow: 20px 0 50px rgba(0,0,0,0.8); }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(2px); }
    .overlay.active { display: block; }
  }

  .sidebar-header { padding: 20px; font-weight: 800; color: var(--primary); font-size: 1.4rem; border-bottom: 1px solid #1e293b; }
  .list-container { flex: 1; overflow-y: auto; padding: 10px; }
  
  .btn-item {
    width: 100%; padding: 12px; margin-bottom: 4px; border-radius: 8px;
    background: transparent; border: none; color: var(--text-muted);
    text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s;
  }
  .btn-item:hover { background: rgba(255,255,255,0.05); }
  .btn-item.active { background: var(--primary); color: #000; font-weight: 600; }

  /* --- CHAT AREA --- */
  .chat-area {
    margin-left: var(--sidebar-w);
    height: 100%; display: flex; flex-direction: column;
    background: var(--bg-panel); transition: margin 0.3s;
  }
  @media (max-width: 768px) { .chat-area { margin-left: 0; } }

  .chat-header {
    height: 60px; padding: 0 15px; display: flex; align-items: center;
    background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
    border-bottom: 1px solid #1e293b; z-index: 10;
  }

  /* HAMBURGER */
  .menu-btn {
    display: none; background: none; border: none; color: var(--primary);
    font-size: 1.5rem; cursor: pointer; margin-right: 15px;
  }
  @media (max-width: 768px) { .menu-btn { display: block; } }

  #messages {
    flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
    background-image: radial-gradient(circle at 1px 1px, #1e293b 1px, transparent 0);
    background-size: 24px 24px;
  }

  /* --- MESSAGES --- */
  .msg {
    max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
    position: relative; word-wrap: break-word;
  }
  @media (max-width: 480px) { .msg { max-width: 88%; } }

  .msg.me { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 4px; box-shadow: 0 4px 12px var(--primary-glow); }
  .msg.them { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 4px; }

  .msg-sender { font-size: 0.7rem; opacity: 0.7; margin-bottom: 2px; display: block !important; }

  /* --- INPUT --- */
  .input-area {
    padding: 12px 15px; background: #0f172a; display: flex; gap: 10px; align-items: center;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
  }
  #messageInput {
    flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #334155;
    background: #1e293b; color: white; outline: none; font-size: 1rem;
  }

  /* Utils */
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #475569; }
  .dot.online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
  #typingIndicator { font-size: 0.75rem; color: var(--primary); font-style: italic; margin-left: 10px; }
  .hidden { display: none !important; }

  /* AUTH */
  #auth {
    position: fixed; inset: 0; background: var(--bg-dark);
    display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
  }
  .auth-card { background: var(--bg-panel); padding: 30px; border-radius: 16px; width: 90%; max-width: 380px; border: 1px solid #1e293b; }
  .auth-card input { width: 100%; padding: 12px; margin-bottom: 10px; background: #0b0f1a; border: 1px solid #334155; color: white; border-radius: 8px; }
  .auth-card button { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }





.avatar-wrap {
  position: relative;
  width: 36px;
  height: 36px;
  flex-shrink: 0;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  background: #1e293b;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #22c55e;
}

.status-dot {
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid #0f172a;
  background: #64748b;
}

.status-dot.online {
  background: #22c55e;
  box-shadow: 0 0 6px #22c55e;
}



.settings-panel {
  position: fixed;
  inset: 0;
  background: var(--bg-panel);
  z-index: 3000;
  display: flex;
  flex-direction: column;
}

.settings-header {
  height: 60px;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 15px;
  font-weight: bold;
  border-bottom: 1px solid #1e293b;
}

.settings-header button {
  background: none;
  border: none;
  color: var(--primary);
  font-size: 1.2rem;
}

.settings-content {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.profile-box {
  display: flex;
  align-items: center;
  gap: 15px;
}

.profile-pic {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  object-fit: cover;
  background: #1e293b;
}

.theme-toggle button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin-right: 10px;
  cursor: pointer;
}

.danger {
  background: #ef4444;
  border: none;
  padding: 12px;
  border-radius: 8px;
  color: white;
  font-weight: bold;
}
body.light {
  --bg-dark: #f8fafc;
  --bg-panel: #ffffff;
  --text-main: #0f172a;
  --text-muted: #475569;
}
/* Enhanced Mobile Responsive Input */
@media (max-width: 768px) {
  #app { height: 100dvh; } /* Use dynamic viewport height */

  .chat-area {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .input-area {
    padding-bottom: max(15px, env(safe-area-inset-bottom));
    background: #0f172a;
    position: sticky;
    bottom: 0;
    width: 100%;
    z-index: 100;
  }

  #messageInput {
    font-size: 16px !important; /* Prevents iOS auto-zoom on focus */
  }
}

/* Reply Preview UI */
#replyPreview {
  background: rgba(34, 197, 94, 0.1);
  border-left: 4px solid var(--primary);
  padding: 8px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.85rem;
}

.reply-content {
  background: rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  padding: 4px 8px;
  margin-bottom: 5px;
  font-size: 0.8rem;
  border-left: 2px solid var(--primary);
}
.emoji-picker-container {
  position: absolute;
  bottom: 70px; /* Adjust based on your input height */
  left: 20px;
  background: rgba(30, 30, 30, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid #333;
  border-radius: 12px;
  padding: 10px;
  display: none; /* Hidden by default */
  grid-template-columns: repeat(6, 1fr);
  gap: 5px;
  width: 280px;
  height: 200px;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

.emoji-btn {
  font-size: 1.2rem;
  cursor: pointer;
  padding: 5px;
  text-align: center;
  border-radius: 5px;
  transition: background 0.2s;
}

.emoji-btn:hover {
  background: rgba(255,255,255,0.1);
}

/* --- IG NOTES --- */
.notes-bar {
  display: flex;
  gap: 10px;
  padding: 10px;
  overflow-x: auto;
}

.note-bubble {
  min-width: 120px;
  max-width: 160px;
  background: #1e293b;
  border-radius: 18px;
  padding: 8px 10px;
  font-size: 0.8rem;
  line-height: 1.2;
  position: relative;
  cursor: pointer;
  animation: popIn 0.25s ease;
}

.note-bubble.me {
  border: 1px dashed var(--primary);
}

.note-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 4px;
}

.note-text {
  color: var(--text-main);
  word-wrap: break-word;
}
.notes-bar::-webkit-scrollbar {
  height: 6px;
}
.notes-bar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
}
.note-actions {
  display: flex;
  gap: 6px;
  margin-top: 4px;
}

.note-reaction {
  font-size: 0.9rem;
  cursor: pointer;
}

.note-reply {
  font-size: 0.7rem;
  opacity: 0.7;
  cursor: pointer;
}

.note-reactions-bar {
  display: flex;
  gap: 4px;
  margin-top: 4px;
  font-size: 0.75rem;
}

/* --- NOTE GLOW ANIMATION --- */
@keyframes noteGlow {
  0% {
    box-shadow: 0 0 0 rgba(34, 197, 94, 0);
  }
  50% {
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.6);
  }
  100% {
    box-shadow: 0 0 0 rgba(34, 197, 94, 0);
  }
}

@keyframes notePop {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.note-bubble {
  transition: transform 0.2s ease;
}

.note-bubble.glow {
  animation: noteGlow 2.2s infinite ease-in-out;
}

.note-bubble.new {
  animation: notePop 0.25s ease-out;
}

.note-bubble:hover {
  transform: translateY(-2px);
}

.reply-bar {
  background: #1e293b;
  padding: 6px 10px;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  gap: 8px;
  border-left: 3px solid var(--primary);
}

.reply-bar.hidden {
  display: none;
}

.reply-bar button {
  margin-left: auto;
  background: none;
  border: none;
  color: #94a3b8;
  cursor: pointer;
}
.last-seen {
  font-size: 0.75rem;
  opacity: 0.7;
  
}
/* Instagram-style Splash */
#splash-screen {
  position: fixed;
  inset: 0;
  background: #0b0f1a; /* Match your bg-dark */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease, visibility 0.5s;
}
.splash-logo {
  width: 80px;
  height: 80px;
  background: #22c55e; /* Match your primary */
  border-radius: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  animation: splashPulse 1.5s infinite ease-in-out;
}
@keyframes splashPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
}
.splash-footer {
  position: absolute;
  bottom: 50px;
  color: #9ca3af;
  font-size: 12px;
  letter-spacing: 2px;
  font-weight: bold;
}


/* Container for the profile item */
.user-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  width: 100%;
  border: none;
  background: transparent;
  cursor: pointer;
  transition: 0.2s;
  text-align: left;
}

.user-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

/* The Circular Avatar */
.avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: #2b5278; /* Telegram-style blue */
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  font-size: 1.1rem;
  flex-shrink: 0;
  position: relative;
}

/* Online green dot */
.status-dot {
  width: 12px;
  height: 12px;
  background: #22c55e;
  border: 2px solid #0b0f1a;
  border-radius: 50%;
  position: absolute;
  bottom: 2px;
  right: 2px;
}

/* Text stacking */
.user-meta {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.user-name {
  font-weight: 600;
  color: #e5e7eb;
  font-size: 0.95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-status {
  font-size: 0.8rem;
  color: #9ca3af;
}

.user-status.online {
  color: #22c55e; /* Telegram-style light blue for online */
}


.search-container {
  padding: 8px 14px;
  background: var(--bg-panel);
  position: sticky;
  top: 0;
  z-index: 100;
}

.search-box {
  background: #242f3d; /* TG Search Dark Blue */
  border-radius: 8px;
  display: flex;
  align-items: center;
  padding: 0 10px;
  border: 2px solid transparent;
  transition: border 0.2s;
}

.search-box:focus-within {
  border-color: var(--primary);
  background: #17212b;
}

.search-icon {
  font-size: 14px;
  color: #708499;
}

#userSearch {
  background: transparent;
  border: none;
  color: white;
  padding: 8px 10px;
  width: 100%;
  outline: none;
  font-size: 0.95rem;
}

#clearSearch {
  background: none;
  border: none;
  color: #708499;
  cursor: pointer;
  font-size: 16px;
  padding: 0 5px;
}

/* No Results Placeholder */
#noResults {
  text-align: center;
  color: #708499;
  padding: 20px;
  display: none;
}

.search-container {
  position: sticky;
  top: 0;
  background: var(--bg-panel);
  padding: 10px 15px;
  z-index: 100;
}

.search-box {
  display: flex;
  align-items: center;
  background: #17212b; /* TG Search BG */
  border-radius: 8px;
  padding: 5px 12px;
  border: 1px solid transparent;
}

.search-box:focus-within {
  border: 1px solid var(--primary);
}

#userSearch {
  background: transparent;
  border: none;
  color: white;
  width: 100%;
  outline: none;
  padding: 5px;
}

#clearSearch {
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 1.1rem;
}
</style>
</head>
<body>

<div id="auth">
  <h2>üí¨ Delta Chat+</h2>
  <input id="email" placeholder="Email" type="email">
  <input id="password" placeholder="Password" type="password">
  <button onclick="authAction('login')">Login</button>
  <button onclick="authAction('signup')" style="background:transparent; border:1px solid var(--primary); color:var(--primary)">Sign Up</button>
</div>

<div id="app">
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header" style="display:flex; justify-content:space-between; align-items:center;">
    <span>üí¨ Delta+</span>
    <button onclick="addNote()" class="icon-btn">Ôºã</button>
  </div>
  <div class="search-container">
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" id="userSearch" placeholder="Search" autocomplete="off">
    <button id="clearSearch" style="display: none;">‚úï</button>
  </div>
</div>
<div id="noResults" style="display: none; text-align: center; color: var(--text-muted); padding: 20px; font-size: 0.9rem;">
  No users found
</div>
<!-- IG NOTES BAR -->
<div id="notesBar" class="notes-bar"></div>

  <div class="list-container">

      <div style="font-size: 0.7rem; color: var(--text-muted); margin: 10px 5px; text-transform: uppercase;">Rooms</div>
      <button class="btn-item active" onclick="switchRoom('global')">üåê Global</button>
      <button class="btn-item" onclick="switchRoom('tech')">üíª Tech</button>
      
      <div style="font-size: 0.7rem; color: var(--text-muted); margin: 20px 5px 10px; text-transform: uppercase;">Private DMs</div>
      <div id="userList"></div>
    </div>
    <div style="padding: 15px; border-top: 1px solid #1e293b;">
      <button class="btn-item" onclick="auth.signOut()" style="color:#ef4444">üö™ Logout</button>
    </div>
    

  </aside>

  <main class="chat-area">
    <header class="chat-header">
      <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
      <div style="flex:1">
        
        <div id="headerTitle" style="font-weight:700;">Global Chat</div>
        
        <div id="typingIndicator"></div>
 <div id="lastSeen" class="last-seen"></div>
      </div>
      <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </header>

    <div id="messages"></div>
<div id="replyBar" class="reply-bar hidden">
  <span id="replyUser"></span>
  <span id="replyText"></span>
  <button onclick="cancelReply()">‚úï</button>
</div>
    <div class="input-area">
      <input type="file" id="imageInput" hidden onchange="handleImageUpload()">
      
      <button class="icon-btn" onclick="document.getElementById('imageInput').click()">üìé</button>
      <button onclick="toggleEmojiPicker()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">üôÇ</button>

      <input id="messageInput" placeholder="Type a message..." autocomplete="off">
      <div id="emojiPicker" class="emoji-picker-container"></div>

      <button class="icon-btn" onclick="sendMessage()"><i class="fa fa-send-o"></i></button>
    </div>
  </main>
</div>

<div id="settingsPanel" class="settings-panel hidden">
  <div class="settings-header">
    <button onclick="closeSettings()">‚Üê</button>
    <span>Settings</span>
  </div>

  <div class="settings-content">
    <div class="profile-box">
      <img id="profilePic" class="profile-pic">
      <input type="file" id="profileUpload" hidden onchange="uploadProfilePic()">
      <button onclick="document.getElementById('profileUpload').click()">Change Photo</button>
    </div>

    <label>Username</label>
    <input id="usernameInput">

    <label>Theme</label>
    <div class="theme-toggle">
      <button onclick="setTheme('dark')">üåô Dark</button>
      <button onclick="setTheme('light')">‚òÄÔ∏è Light</button>
    </div>

    <button class="danger" onclick="logout()">Logout</button>
  </div>
</div>


<script>
// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAoKA7h1wvkzj0Vb_7sD2e9wInbrY6KUxU",
  authDomain: "delta-chat-7214a.firebaseapp.com",
  databaseURL: "https://delta-chat-7214a-default-rtdb.firebaseio.com",
  projectId: "delta-chat-7214a",
  storageBucket: "delta-chat-7214a.appspot.com",
  messagingSenderId: "301493746706",
  appId: "1:301493746706:web:183cb7c548c19bc3972ccb"
};

// Initialize Firebase
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// --- STATE ---
let currentUser = null;
let currentRoom = 'global';
let isPrivate = false;

// --- AUTH & PRESENCE ---
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('auth').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    // Set User Online Status
    const userStatusRef = db.ref(`users/${user.uid}`);
    const connectedRef = db.ref('.info/connected');

    connectedRef.on('value', (snap) => {
      if (snap.val() === true) {
        userStatusRef.onDisconnect().update({ status: 'offline', lastChanged: firebase.database.ServerValue.TIMESTAMP });
    userStatusRef.update({ 
  status: 'online',
  email: user.email,
  username: user.email.split('@')[0],
  photo: user.photoURL || null
});

      }
    });

    loadUsers();
    loadMessages();
  } else {
    document.getElementById('app').style.display = 'none';
    document.getElementById('auth').style.display = 'flex';
  }
  // Add this inside the 'if(user)' block of your auth listener
const userRef = db.ref(`users/${user.uid}`);
const connectedRef = db.ref('.info/connected');

connectedRef.on('value', (snap) => {
  if (snap.val() === true) {
    // When the user closes the app/tab
    userRef.onDisconnect().update({
      status: 'offline',
      lastSeen: firebase.database.ServerValue.TIMESTAMP
    });
    // When the user opens the app
    userRef.update({
      status: 'online',
      lastSeen: firebase.database.ServerValue.TIMESTAMP
    });
  }
});

// Hide Splash Screen after 1.5 seconds
setTimeout(() => {
  const splash = document.getElementById('splash-screen');
  splash.style.opacity = '0';
  setTimeout(() => splash.style.visibility = 'hidden', 500);
}, 1500);
loadNotes();
});



function authAction(type) {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  if(!email || !pass) return alert("Please fill fields");
  
  if(type === 'signup') {
    auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  } else {
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  }
}

function formatLastSeen(timestamp) {
  if (!timestamp) return 'long ago';
  const diff = Date.now() - timestamp;
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);

  if (seconds < 60) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  return new Date(timestamp).toLocaleDateString();
}

function logout() {
  db.ref(`users/${currentUser.uid}`).update({ status: 'offline' });
  auth.signOut();
}

// --- ROOMS & USERS ---
function switchRoom(roomName) {
  currentRoom = roomName;
  isPrivate = false;
  document.getElementById('headerTitle').innerText = roomName.charAt(0).toUpperCase() + roomName.slice(1);
  resetChatUI();
}

function startPrivateChat(targetUid, targetName) {
  const myUid = currentUser.uid;
  // Create unique room ID based on alphabetical order of UIDs
  const roomID = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
  
  currentRoom = `private_${roomID}`;
  isPrivate = true;
  document.getElementById('headerTitle').innerText = `üîí ${targetName}`;
  resetChatUI();
  db.ref(`users/${uid}`).on('value', snap => {
  const u = snap.val();
  if (!u) return;

  const el = document.getElementById('lastSeen');
  el.textContent =
    u.status === 'online'
      ? 'Active now'
      : formatLastSeen(u.lastSeen);
});
// Inside your switchRoom or startPrivateChat function
const subtitle = document.getElementById('headerSubtitle'); // Ensure this ID exists in your HTML header

db.ref(`users/${targetUid}`).on('value', (snap) => {
  const data = snap.val();
  if (data.status === 'online') {
    subtitle.innerHTML = `<span style="color:#22c55e">‚óè Online</span>`;
  } else {
    subtitle.innerText = `Last seen ${formatLastSeen(data.lastSeen)}`;
  }
});
}

function resetChatUI() {
  document.getElementById('messages').innerHTML = '';
  // Update buttons
  document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('active'));
  loadMessages();
}


function loadUsers() {
  db.ref('users').on('value', snap => {
    const list = document.getElementById('userList');
    list.innerHTML = ''; // Clear current list
    
    snap.forEach(child => {
      if (child.key === currentUser.uid) return; // Skip self
      
      const u = child.val();
      const initial = u.username ? u.username[0].toUpperCase() : '?';
      const isOnline = u.status === 'online';
      
      const btn = document.createElement('button');
      btn.className = 'user-item';
      
      // Calculate status display
      let statusText = isOnline ? 'online' : formatLastSeen(u.lastSeen);
      
      btn.innerHTML = `
        <div class="avatar">
          ${initial}
          ${isOnline ? '<div class="status-dot"></div>' : ''}
        </div>
        <div class="user-meta">
          <span class="user-name">${u.username}</span>
          <span class="user-status ${isOnline ? 'online' : ''}">${statusText}</span>
        </div>
      `;
      
      btn.onclick = () => startPrivateChat(child.key, u.username);
      list.appendChild(btn);
    });
  });
}

// --- MESSAGING SYSTEM ---
function sendMessage(imageUrl = null) {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  
  if (!text && !imageUrl) return;

  const msgRef = db.ref(`rooms/${currentRoom}/messages`).push();
  const payload = {
    text: text,
    image: imageUrl,
    sender: currentUser.uid,
   username: document.getElementById('usernameInput')?.value 
          || currentUser.email.split('@')[0],

    timestamp: firebase.database.ServerValue.TIMESTAMP,
    seen: { [currentUser.uid]: true } // Automatically seen by sender
  };

  msgRef.set(payload);
  input.value = '';
}

function handleImageUpload() {
  const file = document.getElementById('imageInput').files[0];
  if(!file) return;

  const ref = storage.ref(`images/${Date.now()}_${file.name}`);
  ref.put(file).then(() => {
    ref.getDownloadURL().then(url => sendMessage(url));
  });
}

function loadMessages() {
  const ref = db.ref(`rooms/${currentRoom}/messages`);
  ref.off(); // Detach old listeners
  
  ref.limitToLast(50).on('child_added', snap => {
    const msg = snap.val();
    const key = snap.key;
    renderMessage(key, msg);
    
    // Mark as seen if not me
    if(msg.sender !== currentUser.uid) {
      db.ref(`rooms/${currentRoom}/messages/${key}/seen/${currentUser.uid}`).set(true);
    }
  });

  // Listener for Reacts & Seen status changes
  ref.limitToLast(50).on('child_changed', snap => {
    const msg = snap.val();
    const key = snap.key;
    const el = document.getElementById(`msg-${key}`);
    if(el) {
      updateReactionsUI(el, msg.reactions);
      updateTicksUI(el, msg.seen);
    }
  });
}

function renderMessage(key, data) {
  const isMe = data.sender === currentUser.uid;
  const div = document.createElement('div');
  div.id = `msg-${key}`;
  div.className = `msg ${isMe ? 'me' : 'them'}`;
  
  // Content
  let content = `<span class="msg-sender">${data.username}</span>`;
  if(data.image) content += `<img src="${data.image}" onclick="window.open(this.src)">`;
  if(data.text) content += `<div>${data.text}</div>`;
  
  // Ticks & Time
  const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  content += `
    <div class="metadata">
      <span>${time}</span>
      ${isMe ? `<span class="tick">‚úì</span>` : ''} 
    </div>
  `;

  // Reactions Container
  content += `
    <div class="reaction-bar" id="reacts-${key}" style="display:none"></div>
    <div class="reaction-picker">
      <span class="emoji-btn" onclick="react('${key}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="emoji-btn" onclick="react('${key}', 'üòÇ')">üòÇ</span>
      <span class="emoji-btn" onclick="react('${key}', 'üëç')">üëç</span>
    </div>
  `;

  div.innerHTML = content;
  
  // Long press/Right click to delete
  div.addEventListener('contextmenu', e => {
    e.preventDefault();
    if(isMe && confirm("Delete message?")) db.ref(`rooms/${currentRoom}/messages/${key}`).remove().then(()=> div.remove());
  });

  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

  // Initial updates
  if(data.reactions) updateReactionsUI(div, data.reactions);
  if(isMe && data.seen) updateTicksUI(div, data.seen);
}

// --- FEATURE: REACTIONS ---
function react(msgId, emoji) {
  const ref = db.ref(`rooms/${currentRoom}/messages/${msgId}/reactions/${emoji}/${currentUser.uid}`);
  // Toggle logic could go here, for now just set true
  ref.set(true);
}

function updateReactionsUI(msgEl, reactions) {
  if(!reactions) return;
  const bar = msgEl.querySelector('.reaction-bar');
  bar.style.display = 'flex';
  bar.innerHTML = '';
  
  Object.keys(reactions).forEach(emoji => {
    const count = Object.keys(reactions[emoji]).length;
    bar.innerHTML += `<span>${emoji} ${count}</span>`;
  });
}

// --- FEATURE: TICKS ---
function updateTicksUI(msgEl, seenData) {
  const tickEl = msgEl.querySelector('.tick');
  if(!tickEl) return;
  
  // Count how many people saw it. >1 means someone other than sender saw it
  const seenCount = seenData ? Object.keys(seenData).length : 0;
  
  if (seenCount > 1) {
    tickEl.textContent = '‚úì‚úì'; // Double tick
    tickEl.classList.add('seen'); // Blue color
  } else {
    tickEl.textContent = '‚úì';
    tickEl.classList.remove('seen');
  }
}

// --- TYPING INDICATOR ---
const msgInput = document.getElementById('messageInput');
msgInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter') sendMessage();
  
  // Set typing status
  db.ref(`rooms/${currentRoom}/typing/${currentUser.uid}`).set(currentUser.email.split('@')[0]);
  setTimeout(() => db.ref(`rooms/${currentRoom}/typing/${currentUser.uid}`).remove(), 1000);
});

// Listen for typing
setInterval(() => {
  if (!currentRoom || !currentUser) return;

  db.ref(`rooms/${currentRoom}/typing`).once('value', snap => {
    const indicator = document.getElementById('typingIndicator');
    if (!indicator) return;

    const val = snap.val();
    if (!val) {
      indicator.textContent = '';
      return;
    }

    const me = currentUser.email.split('@')[0];

    // ‚úÖ Only keep valid string usernames
    const names = Object.values(val).filter(
      name => typeof name === 'string' && name !== me
    );

    indicator.textContent = names.length
      ? (names.length === 1
          ? `${names[0]} is typing...`
          : `${names.join(', ')} are typing...`)
      : '';
  });
}, 1000, 3000);


// --- PWA INSTALLATION (Data URI Trick) ---
const manifest = {
  "name": "Delta Chat+",
  "short_name": "Delta+",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#0b0f1a",
  "theme_color": "#0b0f1a",
  "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/1041/1041916.png", "sizes": "512x512", "type": "image/png" }]
};
const stringManifest = JSON.stringify(manifest);
const blob = new Blob([stringManifest], {type: 'application/json'});
document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
function toggleMenu() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('active');
}

function openSettings() {
  document.getElementById('settingsPanel').classList.remove('hidden');
  loadProfile();
}

function closeSettings() {
  document.getElementById('settingsPanel').classList.add('hidden');
}

function loadProfile() {
  db.ref(`users/${currentUser.uid}`).once('value', snap => {
    const u = snap.val() || {};

    document.getElementById('usernameInput').value = u.username || '';

    document.getElementById('profilePic').src =
      u.photo
        ? u.photo
        : `https://ui-avatars.com/api/?name=${u.username || 'User'}&background=22c55e&color=000`;
  });
}

document.getElementById('usernameInput').addEventListener('input', e => {
  if (!currentUser) return;

  const name = e.target.value.trim();
  if (!name) return;

  db.ref(`users/${currentUser.uid}`).update({
    username: name
  });
});


function uploadProfilePic() {
  const file = document.getElementById('profileUpload').files[0];
  if (!file) return;

  const ref = storage.ref(`avatars/${currentUser.uid}`);
  ref.put(file).then(() => {
    ref.getDownloadURL().then(url => {
      db.ref(`users/${currentUser.uid}`).update({ photo: url });
      document.getElementById('profilePic').src = url;
    });
  });
}
function setTheme(mode) {
  document.body.classList.toggle('light', mode === 'light');
  db.ref(`users/${currentUser.uid}`).update({ theme: mode });
}

// Load saved theme
db.ref(`users/${user.uid}/theme`).once('value', snap => {
  if (snap.val() === 'light') {
    document.body.classList.add('light');
  } else {
    document.body.classList.remove('light');
  }
});


</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("s.js");
}
// 1. Define the emojis you want to show
const emojis = ["üòÄ","üòÇ","üòç","üò≠","üò°","üëç","üëé","üéâ","üî•","‚ù§Ô∏è","üíî","ü§£","üòé","ü§î","üëÄ","üí©","ü•≥","üíÄ","üëª","üëã","üôè","üí™","üíã","‚òÄÔ∏è","üåô","‚≠ê","üçî","üç∫","‚öΩ","üéÆ","üöó","üöÄ","ü•∂","üò∂","üò±","üò®","ü´¢","üòë","ü´•","üòß","ü§ï","üëª","üôåüèæ","üëçüèø","üë≥üèæ‚Äç‚ôÇÔ∏è","üëÆüèø‚Äç‚ôÇÔ∏è"];
// 2. Build the picker UI
function initEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.innerHTML = ''; // Clear existing
    
    emojis.forEach(e => {
        const span = document.createElement('span');
        span.className = 'emoji-btn';
        span.innerText = e;
        span.onclick = () => {
            const input = document.getElementById('messageInput');
            input.value += e; // Add emoji to input
            input.focus();    // Keep keyboard open
        };
        picker.appendChild(span);
    });
}

// 3. Show/Hide toggle
function toggleEmojiPicker() {
    const p = document.getElementById('emojiPicker');
    p.style.display = p.style.display === 'grid' ? 'none' : 'grid';
}

// 4. Run the builder when the page loads
initEmojiPicker();

function addNote() {
  const text = prompt("Add a note (max 60 chars):");
  if (!text || text.length > 60) return;

  db.ref(`notes/${currentUser.uid}`).set({
    text,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
}
function loadNotes() {
  const bar = document.getElementById('notesBar');
  if (!bar) return;

  db.ref('notes').on('value', snap => {
    bar.innerHTML = '';

    snap.forEach(child => {
      const uid = child.key;
      const n = child.val();
      if (!n?.text) return;

      // expire after 24h
      if (Date.now() - n.timestamp > 86400000) {
        db.ref(`notes/${uid}`).remove();
        return;
      }

      db.ref(`users/${uid}`).once('value', uSnap => {
        const u = uSnap.val();
        if (!u) return;

      const div = document.createElement('div');

const isMe = uid === currentUser.uid;
div.className = `note-bubble ${isMe ? 'me' : 'glow'} new`;
if (u.status === 'online' && uid !== currentUser.uid) {
  div.style.boxShadow = '0 0 16px rgba(34,197,94,0.9)';
}

        // reactions
        let reactionsHTML = '';
        if (n.reactions) {
          const counts = {};
          Object.values(n.reactions).forEach(r => counts[r] = (counts[r] || 0) + 1);
          reactionsHTML = Object.entries(counts)
            .map(([k,v]) => `<span>${k} ${v}</span>`)
            .join('');
        }

        div.innerHTML = `
          <img class="note-avatar"
            src="${u.photo || `https://ui-avatars.com/api/?name=${u.username}`}" />
          <div class="note-text">${n.text}</div>

          <div class="note-actions">
            <span class="note-reply">Reply</span>
            <span class="note-reaction" data-r="‚ù§Ô∏è">‚ù§Ô∏è</span>
            <span class="note-reaction" data-r="üòÇ">üòÇ</span>
            <span class="note-reaction" data-r="üëç">üëç</span>
          </div>

          <div class="note-reactions-bar">${reactionsHTML}</div>
        `;

        // tap note ‚Üí open DM
        div.querySelector('.note-text').onclick = () => {
          startPrivateChat(uid, u.username);
        };

        // reply
        div.querySelector('.note-reply').onclick = () => {
          startPrivateChat(uid, u.username, n.text);
        };

        // reactions
        div.querySelectorAll('.note-reaction').forEach(el => {
          el.onclick = () => {
            db.ref(`notes/${uid}/reactions/${currentUser.uid}`)
              .set(el.dataset.r);
          };
        });

        bar.appendChild(div);
        setTimeout(() => div.classList.remove('new'), 1000);

      });
    });
  });
}

const userRef = db.ref(`users/${user.uid}`);

userRef.update({
  status: 'online',
  lastSeen: firebase.database.ServerValue.TIMESTAMP
});

window.addEventListener('beforeunload', () => {
  userRef.update({
    status: 'offline',
    lastSeen: firebase.database.ServerValue.TIMESTAMP
  });
});
function formatLastSeen(ts) {
  if (!ts) return 'last seen long ago';
  
  const diff = Date.now() - ts;
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);

  if (seconds < 60) return 'last seen just now';
  if (minutes < 60) return `last seen ${minutes}m ago`;
  if (hours < 24) return `last seen ${hours}h ago`;
  
  return `last seen ${new Date(ts).toLocaleDateString()}`;
}
const searchInput = document.getElementById('userSearch');
const clearBtn = document.getElementById('clearSearch');

searchInput.addEventListener('input', function(e) {
  const term = e.target.value.toLowerCase().trim();
  const userList = document.getElementById('userList');
  const userItems = userList.querySelectorAll('.user-item');
  const noResults = document.getElementById('noResults');
  
  // Toggle Clear Button (X)
  clearBtn.style.display = term.length > 0 ? 'block' : 'none';

  let matchFound = false;

  userItems.forEach(item => {
    const name = item.querySelector('.user-name-text').innerText.toLowerCase();
    if (name.includes(term)) {
      item.style.display = 'flex';
      matchFound = true;
    } else {
      item.style.display = 'none';
    }
  });

  // Show "No Results" if absolutely nothing matches the database list
  noResults.style.display = (!matchFound && term.length > 0) ? 'block' : 'none';
});

// Clear button logic
clearBtn.onclick = () => {
  searchInput.value = '';
  searchInput.dispatchEvent(new Event('input'));
  searchInput.focus();
};
</script>
</body>
</html>

