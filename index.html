<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Delta Chat+ | Epic</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<script src="https://js.stripe.com/v3/"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<link rel="icon" type="image/png" href="icon1.png">
<link rel="apple-touch-icon" href="icon1.png">
<meta name="theme-color" content="#0f172a" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
  :root {
    --bg-dark: #0f172a;
    --bg-panel: #1e293b;
    --bg-glass: rgba(30, 41, 59, 0.7);
    --border-glass: rgba(255, 255, 255, 0.08);
    
    --primary: #22c55e;
    --primary-glow: rgba(34, 197, 94, 0.4);
    --accent: #3b82f6;
    
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    
    --sidebar-w: 280px;
    --radius-lg: 24px;
    --radius-md: 16px;
    --radius-sm: 12px;
    
    --premium-gold: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
    --premium-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
  }

  * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    background: var(--bg-dark); 
    color: var(--text-main); 
    height: 100vh; 
    overflow: hidden; 
  }

  /* SCROLLBARS */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

  /* --- UTILITIES --- */
  .hidden { display: none !important; }
  .icon-btn {
    background: transparent; border: none; color: var(--text-muted); 
    font-size: 1.1rem; cursor: pointer; padding: 10px; border-radius: 50%; 
    transition: all 0.2s ease;
  }
  .icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-main); transform: scale(1.1); }
  .btn-primary {
    background: var(--primary); color: #000; border: none; padding: 10px 20px;
    border-radius: var(--radius-sm); font-weight: 600; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--primary-glow); }

  /* --- SPLASH SCREEN --- */
  #splash-screen {
    position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s ease;
  }
  .splash-logo {
    width: 80px; height: 80px; background: var(--primary); border-radius: 24px;
    display: flex; align-items: center; justify-content: center; font-size: 40px;
    box-shadow: 0 0 30px var(--primary-glow);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }

  /* --- AUTH SCREEN --- */
  #auth {
    position: fixed; inset: 0; 
    background: radial-gradient(circle at top right, #1e293b, #0f172a);
    display: flex; align-items: center; justify-content: center; z-index: 2000;
  }
  .auth-card {
    background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px);
    border: 1px solid var(--border-glass); padding: 40px; border-radius: var(--radius-lg);
    width: 90%; max-width: 380px; display: flex; flex-direction: column; gap: 15px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }
  .auth-card h2 { margin: 0 0 10px 0; text-align: center; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .auth-input {
    background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass);
    padding: 14px; border-radius: var(--radius-sm); color: white; outline: none;
    transition: border-color 0.2s;
  }
  .auth-input:focus { border-color: var(--primary); }

  /* --- LAYOUT --- */
  #app { display: none; height: 100vh; width: 100vw; display: flex; }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-w); background: rgba(15, 23, 42, 0.95);
    border-right: 1px solid var(--border-glass); display: flex; flex-direction: column;
    z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; }
  .mini-profile { display: flex; align-items: center; gap: 12px; }
  .mini-profile img { width: 40px; height: 40px; border-radius: 12px; object-fit: cover; border: 2px solid var(--border-glass); }
  
  .list-container { flex: 1; overflow-y: auto; padding: 10px; }
  
  .btn-item {
    width: 100%; padding: 12px 15px; margin-bottom: 4px; border-radius: var(--radius-sm);
    background: transparent; border: none; color: var(--text-muted); text-align: left;
    cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s;
    font-size: 0.95rem;
  }
  .btn-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
  .btn-item.active { background: rgba(34, 197, 94, 0.1); color: var(--primary); font-weight: 600; }

  /* CHAT AREA */
  .chat-area {
    flex: 1; display: flex; flex-direction: column; background: var(--bg-dark);
    position: relative; overflow: hidden;
  }
  
  /* Header */
  .chat-header {
    height: 64px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
    background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-glass); z-index: 10;
  }

  /* Messages */
  #messages {
    flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;
    background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0);
    background-size: 24px 24px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 30%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5;
    position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .msg.them {
    background: #1e293b; color: var(--text-main); border-bottom-left-radius: 4px;
    border: 1px solid var(--border-glass);
  }
  .msg.me {
    align-self: flex-end; background: linear-gradient(135deg, var(--primary), #16a34a);
    color: #000; border-bottom-right-radius: 4px; font-weight: 500;
  }
  
  /* Premium & Effects */
  .msg.premium-gold { 
    background: var(--premium-gold); 
    box-shadow: var(--premium-shadow); color: #000; border: none;
  }
  
  .effect-fire { border: 2px solid #ef4444 !important; box-shadow: 0 0 15px #ef4444; }
  .effect-confetti { border: 2px solid #a855f7 !important; box-shadow: 0 0 15px #a855f7; }

  /* Reply Bubble inside Message */
  .msg-reply-context {
    background: rgba(0,0,0,0.2); border-left: 2px solid rgba(255,255,255,0.5);
    padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 6px;
    opacity: 0.8; cursor: pointer;
  }

  .msg img { max-width: 100%; border-radius: 12px; margin-top: 8px; cursor: pointer; }
  
  .metadata { font-size: 0.7rem; display: flex; justify-content: flex-end; gap: 4px; opacity: 0.7; margin-top: 4px; }
  .tick.seen { color: #81e6d9; text-shadow: 0 0 5px rgba(129, 230, 217, 0.5); }
  
  /* Pinned Icon */
  .pinned-icon { position: absolute; top: -8px; right: -8px; background: var(--accent); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

  /* Input Area */
  .input-area {
    padding: 15px 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-glass); display: flex; gap: 12px; align-items: center;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
  }
  #messageInput {
    flex: 1; padding: 14px 20px; border-radius: 30px; border: 1px solid var(--border-glass);
    background: rgba(30, 41, 59, 0.5); color: white; outline: none; transition: 0.2s;
  }
  #messageInput:focus { border-color: var(--primary); background: rgba(30, 41, 59, 0.8); }

  /* --- EPIC SETTINGS PANEL --- */
  .settings-panel {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
    z-index: 3000; display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: 0.3s ease;
  }
  .settings-panel:not(.hidden) { opacity: 1; pointer-events: all; }

  .settings-card {
    background: #1e293b; width: 100%; max-width: 480px; height: 85vh;
    border-radius: var(--radius-lg); border: 1px solid var(--border-glass);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    display: flex; flex-direction: column; overflow: hidden;
    transform: translateY(20px); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .settings-panel:not(.hidden) .settings-card { transform: translateY(0); }

  .settings-header {
    padding: 20px; border-bottom: 1px solid var(--border-glass);
    display: flex; align-items: center; gap: 15px; font-weight: 700; font-size: 1.1rem;
  }

  .settings-content { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 24px; }

  /* Settings Sections */
  .st-section { background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 15px; border: 1px solid var(--border-glass); }
  .st-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 12px; display: block; 
    font-weight: 600; }
  
  /* Profile Upload */
  .profile-hero { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 10px; }
  .profile-upload-wrap { position: relative; width: 100px; height: 100px; cursor: pointer; transition: transform 0.2s; }
  .profile-upload-wrap:hover { transform: scale(1.05); }
  .profile-hero img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--bg-panel); box-shadow: 0 0 0 3px var(--primary); }
  .upload-icon-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: white; opacity: 0; transition: 0.2s;
  }
  .profile-upload-wrap:hover .upload-icon-overlay { opacity: 1; }

  .st-input {
    width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--border-glass);
    padding: 10px 0; color: white; font-size: 1rem; outline: none; transition: 0.3s;
  }
  .st-input:focus { border-color: var(--primary); }

  /* Premium Box */
  .premium-box {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(184, 134, 11, 0.05));
    border: 1px solid rgba(255, 215, 0, 0.3); position: relative; overflow: hidden;
  }
  .premium-box::before {
    content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 70px !important; background: var(--premium-gold);
  }
  
  .settings-btn {
    width: 100%; padding: 14px; border-radius: var(--radius-sm); border: none;
    background: var(--bg-glass); color: white; font-weight: 500; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    border: 1px solid var(--border-glass); transition: 0.2s; margin-bottom: 8px;
  }
  .settings-btn:hover { background: rgba(255,255,255,0.08); }
  
  .btn-gold { background: var(--premium-gold); color: black; font-weight: bold; border: none; box-shadow: var(--premium-shadow); }
  .btn-gold:hover { transform: scale(1.02); }
  .btn-danger { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05); }

  /* --- RESPONSIVE --- */
  @media (max-width: 768px) {
    .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); box-shadow: 50px 0 100px rgba(0,0,0,0.5); }
    .menu-btn { display: block; margin-right: 15px; }
    .chat-area { margin-left: 0; }
    .settings-card { width: 100%; height: 100%; max-width: none; border-radius: 0; }
    .msg { max-width: 85%; }
  }
  .menu-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

  /* --- SEARCH --- */
  .search-box {
    background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); padding: 8px 12px;
    display: flex; align-items: center; gap: 8px; margin: 15px; border: 1px solid transparent;
  }
  .search-box:focus-within { border-color: var(--primary); background: rgba(0,0,0,0.5); }
  .search-box input { background: transparent; border: none; color: white; width: 100%; outline: none; }

  /* --- NOTES --- */
  .notes-bar { display: flex; gap: 12px; padding: 15px; overflow-x: auto; scrollbar-width: none; }
  .note-bubble {
    min-width: 100px; max-width: 140px; background: #1e293b; border-radius: 18px; padding: 10px;
    font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border-glass); transition: 0.2s;
    display: flex; flex-direction: column; gap: 6px;
  }
  .note-bubble:hover { transform: translateY(-3px); border-color: var(--primary); }
  .note-bubble.me { border: 1px dashed var(--text-muted); opacity: 0.8; }
  .note-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--bg-panel); }

  /* --- CONTEXT MENU --- */
  .context-menu {
    position: fixed; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
    border: 1px solid var(--border-glass); border-radius: 12px; padding: 6px;
    display: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }
  .ctx-item { padding: 10px 20px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; border-radius: 6px; }
  .ctx-item:hover { background: var(--primary); color: black; }

  /* Premium Effects & Styles */
  .premium-user { color: #facc15 !important; text-shadow: 0 0 10px rgba(250, 204, 21, 0.3); font-weight: 700 !important; }
  .verified-badge { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; color: white; font-size: 9px; margin-left: 4px; }
  
  
.custom-wall { background-size: cover !important; background-position: center !important; }



/* Add this to your <style> section */

.premium-badge {
  background: linear-gradient(135deg, #ffd700, #edf50b) !important;
  color: black;
  font-size: 0.6rem;
  font-weight: 800;
  padding: 2px 6px;
  border-radius: 6px;
  margin-left: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 0 10px rgba(255, 230, 3, 0.7);
  display: inline-block;
  vertical-align: middle;
}

.last-seen-text {
  font-size: 0.75rem;
  color: #64748b; /* Slate-500 */
  display: block;
  margin-top: 2px;
}


/* Ensure the menu button is visible and styled on mobile */
@media (max-width: 768px) {
  .menu-btn {
    display: flex !important; /* Force display on mobile */
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    margin-right: 10px;
    font-size: 1.5rem;
    color: var(--text-main);
    z-index: 101;
  }

  .sidebar {
    position: fixed;
    height: 100%;
    left: 0;
    top: 0;
    transform: translateX(-100%); /* Hidden by default */
    z-index: 1000; /* Sit above everything */
    width: 80%; /* Takes up most of the screen on mobile */
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sidebar.open {
    transform: translateX(0); /* Slide in */
  }

  /* The overlay to dim the background when menu is open */
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 900;
    display: none;
  }
  
  #overlay.active {
    display: block;
  }
}
/* Premium Gold Ring Effect */
.premium-ring {
  box-shadow: 0 0 0 2px var(--bg-dark), 0 0 0 4px #ffd700;
  animation: gold-glow 1.5s infinite alternate;
}

@keyframes gold-glow {
  from { box-shadow: 0 0 0 2px var(--bg-dark), 0 0 0 4px #ffd700; }
  to { box-shadow: 0 0 0 2px var(--bg-dark), 0 0 8px 4px #ffd901; }
}

/* Verified Blue Tick */
.verified-tick {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 14px;
  height: 14px;
  background: #3b82f6;
  color: white;
  border-radius: 50%;
  font-size: 8px;
  margin-left: 4px;
  vertical-align: middle;
}

.premium-avatar { 
  padding: 2px; 
  background: var(--premium-gold); 
  border-radius: 50%; 
}
.premium-user {
  color: #ffca28 !important; /* Gold text */
  text-shadow: 0 0 8px rgba(255, 202, 40, 0.4);
  font-weight: 800 !important;
}

/* Message Ticks */
.tick-wrapper {
  display: inline-flex;
  align-items: center;
  margin-left: 4px;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.tick-wrapper.seen {
  color: #3b82f6; /* Blue for seen */
  text-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
}

/* Double tick icon positioning */
.fa-check-double {
  letter-spacing: -3px;
}

@keyframes messageSlideIn {
  from { opacity: 0; transform: translateY(10px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.msg {
  animation: messageSlideIn 0.2s ease-out forwards;
  transition: all 0.2s ease;
}

/* Telegram-style "Message Sent" bounce */
.msg.me {
  transform-origin: right bottom;
}
/* ===============================
   MESSAGE LIST CONTAINER
================================ */
#messages {
  height: 100%;
  overflow-y: auto;
  padding: 12px;
  scroll-behavior: smooth;
  overscroll-behavior: contain;
}

/* ===============================
   MESSAGE BUBBLES
================================ */
.message {
  max-width: 70%;
  margin-bottom: 8px;
  padding: 10px 14px;
  border-radius: 14px;
  background: #2b2f3a;
  color: #fff;
  word-wrap: break-word;

  /* Spring animation */
  animation: popIn 0.35s cubic-bezier(.22,1.61,.36,1);
}

.message.me {
  margin-left: auto;
  background: #4e8cff;
}

/* ===============================
   SPRING EFFECT
================================ */
@keyframes popIn {
  from {
    opacity: 0;
    transform: translateY(8px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* ===============================
   SCROLL TO BOTTOM BUTTON
================================ */
#scrollBottomBtn {
  position: absolute;
  bottom: 80px;
  right: 16px;
  background: #4e8cff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
  align-items: center;
}

#splash-screen {
    position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s ease;
  }

  .splash-logo {
    width: 120px; height: 120px;
    display: flex; align-items: center; justify-content: center;
  }

  .infinity-svg {
    width: 100%; height: 100%;
    fill: none;
    stroke-width: 6;
    stroke-linecap: round;
  }

  /* The stationary part of the line */
  .bg-path {
    stroke: #1e293b; /* Dark slate line */
  }

  /* The moving green "pulse" inside the line */
  .moving-path {
    stroke: var(--primary); /* Your green color */
    stroke-dasharray: 40 120; /* 40 is the length of the green "thing" */
    stroke-dashoffset: 160;
    animation: snake-run 2s linear infinite;
    filter: drop-shadow(0 0 8px var(--primary)); /* Makes the green thing glow */
  }

  @keyframes snake-run {
    from { stroke-dashoffset: 160; }
    to { stroke-dashoffset: 0; }
  }

  .splash-text {
    margin-top: 20px;
    font-weight: 800;
    letter-spacing: 5px;
    color: var(--text-muted);
    animation: text-pulse 2s ease-in-out infinite;
  }

  @keyframes text-pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; color: var(--primary); }
  }
</style>
</head>
<body>

<div id="splash-screen">
  <div class="splash-logo">
    <svg viewBox="0 0 100 100" class="infinity-svg">
      <path class="bg-path" d="M30,50 c0,-15 15,-20 20,-5 c5,15 20,20 20,5 c0,-15 -15,-20 -20,-5 c-5,15 -20,20 -20,5 z" />
      <path class="moving-path" d="M30,50 c0,-15 15,-20 20,-5 c5,15 20,20 20,5 c0,-15 -15,-20 -20,-5 c-5,15 -20,20 -20,5 z" />
    </svg>
  </div>
  <div class="splash-text">DELTA CHAT+</div>
</div>

<div id="auth">
  <div class="auth-card">
    <h2>Welcome Back</h2>
    <input id="email" class="auth-input" placeholder="Email Address" type="email" />
    <input id="password" class="auth-input" placeholder="Password" type="password" />
    <button class="btn-primary" onclick="authAction('login')">Log In</button>
    <button onclick="authAction('signup')" style="background:transparent; border:none; color:var(--text-muted); cursor:pointer; margin-top:10px;">Create an account</button>
  </div>
</div>

<div id="app">
  <div class="overlay" id="overlay" onclick="toggleMenu()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:90;"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="mini-profile">
        <img id="miniProfilePic" src="" onerror="this.src='https://ui-avatars.com/api/?background=random'" />
        <div style="display:flex;flex-direction:column">
          <strong id="miniName" style="font-size:0.95rem">...</strong>
          <span id="miniStatus" style="font-size:0.75rem; color:var(--primary)">Online</span>
        </div>
      </div>
      <button onclick="addNote()" class="icon-btn" title="Add Note"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div class="search-box">
      <i class="fa-solid fa-magnifying-glass" style="color:var(--text-muted)"></i>
      <input type="text" id="userSearch" placeholder="Search people..." autocomplete="off" />
    </div>

    <div id="notesBar" class="notes-bar"></div>

    <div class="list-container">
      <div style="font-size: 0.7rem; color: var(--text-muted); margin: 15px; font-weight:700;">CHANNELS</div>
      <button id="btn-global" class="btn-item active" onclick="switchRoom('global')">üåê Global</button>
      <button id="btn-tech" class="btn-item" onclick="switchRoom('tech')">üíª Tech Talk</button>

      <div style="font-size: 0.7rem; color: var(--text-muted); margin: 25px 15px 10px; font-weight:700;">DIRECT MESSAGES</div>
      <div id="userList"></div>
    </div>

    <div style="padding: 20px; border-top: 1px solid var(--border-glass);">
      <button class="btn-item" onclick="openSettings()"><i class="fa-solid fa-gear"></i> Settings</button>
      <button class="btn-item" onclick="logout()" style="color:#ef4444"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button>
    </div>
  </aside>

  <main class="chat-area" id="chatWrapper" style="position:relative;height:100%">
    <header class="chat-header">
      <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
      <div style="flex:1">
        <div id="headerTitle" style="font-weight:700; font-size:1.1rem;">Global Chat</div>
        <div id="headerSubtitle" style="font-size:0.8rem; color:var(--text-muted)">Welcome to the community</div>
        <div id="typingIndicator" style="font-size:0.75rem; color:var(--primary); height:14px;"></div>
      </div>
      <button class="icon-btn" onclick="openSettings()"><i class="fa-solid fa-sliders"></i></button>
    </header>

    <div id="messages"></div>
 <button id="scrollBottomBtn">‚Üì</button>
    <div id="replyBar" class="hidden" style="background:#1e293b; padding:10px; border-left:3px solid var(--primary); display:flex; justify-content:space-between; align-items:center; margin:0 20px;">
      <div style="flex:1; overflow:hidden;">
        <span style="font-size:0.75rem; color:var(--primary); font-weight:bold;">Replying to <span id="replyUser"></span></span>
        <div id="replyText" style="font-size:0.85rem; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;"></div>
      </div>
      <button onclick="cancelReply()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; padding:5px;"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="input-area">
      <input type="file" id="imageInput" hidden accept="image/*" onchange="handleFileUpload('image')" />
      <button class="icon-btn" onclick="document.getElementById('imageInput').click()"><i class="fa-regular fa-image"></i></button>
      
      <input id="messageInput" placeholder="Type a message..." />
      
      <div id="effectIndicator" onclick="cycleNextEffect()" style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size:0.9rem; color:var(--text-muted); padding:0 10px; transition:0.2s;">
        <i class="fa-solid fa-wand-magic-sparkles"></i> <span id="effectLabel" style="display:none; font-size:0.8rem;"></span>
      </div>

      <button class="icon-btn" style="background:var(--primary); color:black; border-radius:50%; width:42px; height:42px; display:flex; align-items:center; justify-content:center;" onclick="sendMessage()">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </main>
</div>

<div id="ctx-menu" class="context-menu">
  <div class="ctx-item" onclick="startReplyAction()"><i class="fa-solid fa-reply"></i> Reply</div>
  <div class="ctx-item" onclick="editMessageAction()"><i class="fa-solid fa-pen"></i> Edit</div>
  <div class="ctx-item" onclick="pinMessageAction()"><i class="fa-solid fa-thumbtack"></i> Pin Message</div>
  <div class="ctx-item" onclick="deleteMessageAction()" style="color:#ef4444"><i class="fa-solid fa-trash"></i> Delete</div>
</div>

<div id="settingsPanel" class="settings-panel hidden">
  <div class="settings-card">
    <div class="settings-header">
      <button onclick="closeSettings()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-arrow-left"></i></button>
      <span>Settings</span>
    </div>

    <div class="settings-content">
      <div class="profile-hero">
        <div class="profile-upload-wrap" onclick="document.getElementById('profileUpload').click()">
          <img id="profilePic" src="" />
          <div class="upload-icon-overlay"><i class="fa-solid fa-camera fa-lg"></i></div>
        </div>
        <input type="file" id="profileUpload" hidden onchange="uploadProfilePic()" />
        <div style="text-align:center;">
          <input id="usernameInput" class="st-input" style="text-align:center; font-weight:700; font-size:1.2rem; border-bottom:1px solid transparent;" placeholder="Username" onblur="updateUsername(this.value)" />
          <span id="userEmailDisplay" style="font-size:0.8rem; color:var(--text-muted)">email@example.com</span>
        </div>
      </div>

        <div id="premiumPromo" class="st-section premium-box" style="height: 700px !important; padding-bottom: 180px;" >
        <span class="st-label" style="color:#ffd700"><i class="fa-solid fa-crown"></i> Delta Premium</span>
        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Unlock gold badge, exclusive themes, animated reactions, and priority support.

Click below to request access‚Äîonly the worthy will be granted Premium.</p>
        <button id="buyPremiumBtn" onclick="startPurchase()" class="settings-btn btn-gold">Upgrade to Premium</button>
      </div>

      <div id="premiumSection" class="st-section hidden" style="border:1px solid #ffd700;">
        <span class="st-label" style="color:#ffd700">Premium Controls</span>
        
        <label style="font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; display:block;">Chat Wallpaper</label>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <button onclick="document.getElementById('wallInput').click()" class="settings-btn"><i class="fa-regular fa-image"></i> Change BG</button>
          <button onclick="resetWallpaper()" class="settings-btn" style="width:auto; border-color:#ef4444; color:#ef4444"><i class="fa-solid fa-trash"></i></button>
          <input type="file" id="wallInput" hidden accept="image/*" onchange="uploadWallpaper()" />
        </div>

        <label style="font-size:0.85rem; color:var(--text-muted); margin-bottom:8px; display:block;">Accent Color</label>
        <div style="display:flex; align-items:center; gap:10px;">
          <input type="color" id="colorPicker" value="#22c55e" onchange="saveThemeColor(this.value)" style="height:40px; width:100%; border:none; background:none; cursor:pointer;" />
        </div>
      </div>

      <div id="adminPanel" class="st-section hidden">
        <span class="st-label">Admin Requests</span>
        <div id="premiumRequestsList">Loading...</div>
      </div>

      <div class="st-section">
         <span class="st-label">Account</span>
         <button class="settings-btn btn-danger" onclick="logout()">Log Out</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== FIREBASE INIT ================== */
const firebaseConfig = {
  apiKey: "AIzaSyAoKA7h1wvkzj0Vb_7sD2e9wInbrY6KUxU",
  authDomain: "delta-chat-7214a.firebaseapp.com",
  databaseURL: "https://delta-chat-7214a-default-rtdb.firebaseio.com",
  projectId: "delta-chat-7214a",
  storageBucket: "delta-chat-7214a.appspot.com",
  messagingSenderId: "301493746706",
  appId: "1:301493746706:web:183cb7c548c19bc3972ccb"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

/* ================== GLOBAL STATE ================== */
let currentUser = null;
let currentRoom = 'global';
let isCurrentUserPremium = false;
let selectedMessage = null; // {id, data} for Context Menu
let replyToData = null; // {id, username, text}
let nextEffect = null;
const EFFECTS = [null, 'fire', 'confetti'];
let effectIndex = 0;
const messagesEl = document.getElementById("messages");
const scrollBtn = document.getElementById("scrollBottomBtn");

const PAGE_SIZE = 30;
let oldestKey = null;
let loadingOld = false;
let autoScroll = true;

/* ================== AUTH & PRESENCE ================== */
/* ================== AUTH & PRESENCE ================== */
auth.onAuthStateChanged(user => {
  const splash = document.getElementById('splash-screen');
  const authArea = document.getElementById('auth');
  const appArea = document.getElementById('app');

  // We set a minimum display time of 6 seconds (6000ms)
  const minimumDisplayTime = 6000;
  const startTime = Date.now();

  if (user) {
    currentUser = user;
    
    // Calculate how much time is left to reach 6 seconds
    const timeElapsed = Date.now() - startTime;
    const remainingTime = Math.max(0, minimumDisplayTime - timeElapsed);

    setTimeout(() => {
      authArea.style.display = 'none';
      appArea.style.display = 'flex';
      
      // Smooth fade out
      splash.style.opacity = '0';
      setTimeout(() => splash.classList.add('hidden'), 500);
    }, remainingTime);

    const userRef = db.ref(`users/${user.uid}`);
    
    // Online/Offline presence
    db.ref('.info/connected').on('value', snap => {
      if (snap.val() === true) {
        userRef.onDisconnect().update({ 
          status: 'offline', 
          lastSeen: firebase.database.ServerValue.TIMESTAMP 
        });
        userRef.update({ 
          status: 'online', 
          email: user.email,
          lastSeen: firebase.database.ServerValue.TIMESTAMP 
        });
      }
    });

    userRef.on('value', snap => {
      const data = snap.val() || {};
      isCurrentUserPremium = data.isPremium === true;
      updateUIWithUserData(data);
      checkAdmin(user.uid);
    });

    loadUsers(); 
    loadMessages(); 
    loadNotes(); 
    // ... (rest of your Firebase user data/presence logic)
    
  } else {
    // If no user, we still wait 6s for the "Intro" vibe, then show login
    setTimeout(() => {
      currentUser = null;
      authArea.style.display = 'flex';
      appArea.style.display = 'none';
      splash.classList.add('hidden');
    }, minimumDisplayTime);
  }
});

function logout() {
  if (currentUser) {
    // Set status to offline before signing out
    db.ref(`users/${currentUser.uid}`).update({ 
      status: 'offline',
      lastSeen: firebase.database.ServerValue.TIMESTAMP 
    }).then(() => {
      auth.signOut(); 
      // Removed location.reload() -> let the listener above handle the UI switch
    });
  }
}

function authAction(type) {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  if(!email || !pass) return alert("Please enter email and password");
  
  if(type === 'signup') auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  else auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}




/* ================== UI & HELPERS ================== */
function updateUIWithUserData(data) {
  const myName = data.username || currentUser.email.split('@')[0];
  const myFirstLetter = myName.charAt(0).toUpperCase();
  
  // Update Sidebar Profile
  document.getElementById('miniName').innerText = myName;
  document.getElementById('miniProfilePic').src = data.photo || `https://ui-avatars.com/api/?name=${myFirstLetter}&background=random&color=fff`;
  
  // Update Settings Profile
  document.getElementById('profilePic').src = data.photo || `https://ui-avatars.com/api/?name=${myFirstLetter}&background=random&color=fff`;
  
  // ... rest of your premium/wallpaper logic
}

function updateUsername(newName) {
  if(!currentUser || !newName) return;
  db.ref(`users/${currentUser.uid}`).update({ username: newName });
}

function toggleMenu() { 
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  
  sidebar.classList.toggle('open');
  
  if (sidebar.classList.contains('open')) {
    overlay.style.display = 'block';
    overlay.classList.add('active');
  } else {
    overlay.style.display = 'none';
    overlay.classList.remove('active');
  }
}

function openSettings() { document.getElementById('settingsPanel').classList.remove('hidden'); }
function closeSettings() { document.getElementById('settingsPanel').classList.add('hidden'); }
function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function isAtBottom() {
  return (
    messagesEl.scrollHeight -
    messagesEl.scrollTop -
    messagesEl.clientHeight < 40
  );
}

/* ================== CORE MESSAGING & DM LOGIC ================== */

// 1. Switch Room (Global / Tech / Private)
function switchRoom(room) {
  if (currentRoom === room) return;
  currentRoom = room;
  
  // Sidebar styling
  document.querySelectorAll('.btn-item').forEach(b => b.classList.remove('active'));
  
  if(room === 'global') {
     document.getElementById('btn-global').classList.add('active');
     document.getElementById('headerTitle').innerText = 'Global Chat';
     document.getElementById('headerSubtitle').innerText = 'Welcome to the community';
  } else if (room === 'tech') {
     document.getElementById('btn-tech').classList.add('active');
     document.getElementById('headerTitle').innerText = 'Tech Talk';
     document.getElementById('headerSubtitle').innerText = 'Discussing code & hardware';
  }
  
  loadMessages();
  if (document.getElementById('sidebar').classList.contains('open')) toggleMenu();
}
function loadInitialMessages() {
  const ref = db.ref(`rooms/${currentRoom}/messages`)
    .orderByKey()
    .limitToLast(PAGE_SIZE);

  ref.once("value", snap => {
    messagesEl.innerHTML = "";
    snap.forEach(child => {
      renderMessage(child.key, child.val());
      oldestKey = child.key;
    });
    scrollToBottom();
  });
}
function loadOlderMessages() {
  if (!oldestKey) return;
  loadingOld = true;

  const prevHeight = messagesEl.scrollHeight;

  db.ref(`rooms/${currentRoom}/messages`)
    .orderByKey()
    .endBefore(oldestKey)
    .limitToLast(PAGE_SIZE)
    .once("value", snap => {
      const batch = [];
      snap.forEach(c => batch.push(c));
      if (!batch.length) return;

      batch.forEach(c => renderMessage(c.key, c.val(), true));
      oldestKey = batch[0].key;

      messagesEl.scrollTop =
        messagesEl.scrollHeight - prevHeight;

      loadingOld = false;
    });
}

// 2. Open Direct Message (The Logic from Index 2)
function openDirectMessage(targetUid, targetName, targetPhoto) {
  if (!currentUser) return;

  const ids = [currentUser.uid, targetUid].sort();
  const newRoomId = `dm_${ids[0]}_${ids[1]}`;

  if (currentRoom === newRoomId) return;
  currentRoom = newRoomId;

  // Header update
  document.getElementById('headerTitle').innerText = targetName;
  document.getElementById('headerSubtitle').innerText = "Private Conversation";

  // Sidebar highlight
  document.querySelectorAll('.btn-item').forEach(b => b.classList.remove('active'));
  const userBtn = document.getElementById(`user-btn-${targetUid}`);
  if (userBtn) userBtn.classList.add('active');

  loadMessages();
  if (document.getElementById('sidebar').classList.contains('open')) toggleMenu();
}

// 3. Send Message
function sendMessage(imageUrl = null) {
  if(!currentUser) return;
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  
  if(!text && !imageUrl) return;

  // Get current username for the message
  const myName = document.getElementById('miniName').innerText;

  const msgData = {
    text: text,
    image: imageUrl,
    sender: currentUser.uid,
    username: myName,
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    effect: nextEffect,
    replyTo: replyToData,
    seen: { [currentUser.uid]: true }
  };

  db.ref(`rooms/${currentRoom}/messages`).push(msgData);
  input.value = '';
  
  // Reset effects & reply
  nextEffect = null; 
  effectIndex = 0;
  document.getElementById('effectLabel').style.display = 'none';
  document.getElementById('effectIndicator').style.color = "var(--text-muted)";
  cancelReply();



  messagesEl.addEventListener("scroll", () => {
  autoScroll = isAtBottom();
  scrollBtn.style.display = autoScroll ? "none" : "block";

  if (messagesEl.scrollTop < 50 && !loadingOld) {
    loadOlderMessages();
  }
});

scrollBtn.onclick = scrollToBottom;

}

// 4. Render Message
function renderMessage(key, data) {
  if(document.getElementById(`msg-${key}`)) return;

  const isMe = data.sender === currentUser.uid;
  const msgDiv = document.createElement('div');
  msgDiv.id = `msg-${key}`;
  
  let classes = `msg ${isMe ? 'me' : 'them'}`;
  if(isMe && isCurrentUserPremium) classes += ' premium-gold';
  if(data.effect) classes += ` effect-${data.effect}`;
  msgDiv.className = classes;

  // Determine Seen Status (for DMs)
  let seenStatus = '';
  if (isMe) {
    // Check if the other person has seen it
    // In a DM, the 'seen' object will have 2 keys if both have read it
    const seenCount = data.seen ? Object.keys(data.seen).length : 0;
    const isSeen = seenCount > 1; 
    
    seenStatus = `
      <div class="tick-wrapper ${isSeen ? 'seen' : ''}">
        <i class="fa-solid ${isSeen ? 'fa-check-double' : 'fa-check'}"></i>
      </div>
    `;
  }

  let content = '';
  if(data.replyTo) {
    content += `<div class="msg-reply-context" onclick="scrollToMessage('${data.replyTo.id}')">
      <strong>${data.replyTo.username}</strong>: ${data.replyTo.text.substring(0,20)}...
    </div>`;
  }

  if(!isMe) content += `<div style="font-size:0.7rem; color:var(--primary); font-weight:700; margin-bottom:2px;">${data.username}</div>`;
  if(data.image) content += `<img src="${data.image}" onclick="window.open(this.src)" />`;
  if(data.text) content += `<div>${data.text}</div>`;
  
  const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  content += `<div class="metadata">${time} ${seenStatus}</div>`;

  msgDiv.innerHTML = content;
  
  // Context menu trigger
  msgDiv.oncontextmenu = (e) => {
    e.preventDefault();
    selectedMessage = { id: key, ...data }; 
    const menu = document.getElementById('ctx-menu');
    menu.style.display = 'block';
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
  };

  document.getElementById('messages').appendChild(msgDiv);
 
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

  const div = document.createElement("div");
  div.className = "message" + (data.sender === currentUser.uid ? " me" : "");
  div.id = `msg-${id}`;
  div.textContent = data.text;

  if (prepend) {
    messagesEl.prepend(div);
  } else {
    messagesEl.append(div);
    if (autoScroll) scrollToBottom();
  }

}
function deleteMessageAction() {
  if (!selectedMessage || !currentUser) return;

  // Only allow deleting your own messages
  if (selectedMessage.sender !== currentUser.uid) {
    alert("You can only delete your own messages.");
    closeContextMenu();
    return;
  }

  const confirmDelete = confirm("Delete this message?");
  if (!confirmDelete) {
    closeContextMenu();
    return;
  }

  db.ref(`rooms/${currentRoom}/messages/${selectedMessage.id}`)
    .remove()
    .then(() => {
      // Remove from UI instantly
      const msgEl = document.getElementById(`msg-${selectedMessage.id}`);
      if (msgEl) msgEl.remove();
      closeContextMenu();
    })
    .catch(err => {
      alert("Failed to delete message");
      console.error(err);
    });
}
function closeContextMenu() {
  const menu = document.getElementById('ctx-menu');
  menu.style.display = 'none';
  selectedMessage = null;
}
document.addEventListener('click', () => {
  closeContextMenu();
});


function loadMessages() {
  const ref = db.ref(`rooms/${currentRoom}/messages`);
  const messagesEl = document.getElementById('messages');
  messagesEl.innerHTML = '';

  ref.off();

  ref.limitToLast(50).on('child_added', snap => {
    renderMessage(snap.key, snap.val());

    // Mark seen
    if (snap.val().sender !== currentUser.uid) {
      db.ref(`rooms/${currentRoom}/messages/${snap.key}/seen/${currentUser.uid}`).set(true);
    }
  });

  ref.on('child_changed', snap => {
    const el = document.getElementById(`msg-${snap.key}`);
    if (el) el.remove();
    renderMessage(snap.key, snap.val());
  });

  // üî• THIS FIXES DELETE UI
  ref.on('child_removed', snap => {
    const el = document.getElementById(`msg-${snap.key}`);
    if (el) el.remove();
  });
  
}


// 5. Typing Indicator Logic
const msgInput = document.getElementById('messageInput');
if(msgInput) {
    msgInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') sendMessage();
        if(currentUser && currentRoom) {
            db.ref(`rooms/${currentRoom}/typing/${currentUser.uid}`).set(document.getElementById('miniName').innerText);
            setTimeout(() => db.ref(`rooms/${currentRoom}/typing/${currentUser.uid}`).remove(), 1000);
        }
    });
}
setInterval(() => {
    if(!currentRoom) return;
    db.ref(`rooms/${currentRoom}/typing`).once('value', snap => {
        const val = snap.val();
        const indicator = document.getElementById('typingIndicator');
        if(!val) { indicator.innerText = ''; return; }
        const names = Object.values(val).filter(n => n !== document.getElementById('miniName').innerText);
        if(names.length) indicator.innerText = `${names.join(', ')} is typing...`;
        else indicator.innerText = '';
    });
}, 2000);

/* ================== USER LIST & NOTES ================== */
function loadUsers() {
  db.ref('users').on('value', snap => {
    const list = document.getElementById('userList');
    list.innerHTML = '';
    
    snap.forEach(child => {
      if (child.key === currentUser.uid) return;
      const u = child.val();
      const uid = child.key;
      
      const firstLetter = u.username ? u.username.charAt(0).toUpperCase() : 'U';
      const dynamicAvatar = u.photo || `https://ui-avatars.com/api/?name=${firstLetter}&background=random&color=fff`;

      // 1. Premium Ring Logic
      const ringClass = u.isPremium ? 'premium-ring' : '';
      
      // 2. Verified Tick Logic
      const verifiedBadge = u.isVerified 
        ? `<span class="verified-tick"><i class="fa-solid fa-check"></i></span>` 
        : '';

      const btn = document.createElement('button');
      btn.className = 'btn-item';
      btn.id = `user-btn-${uid}`;
      
      btn.innerHTML = `
        <div style="position:relative; padding: 4px;">
          <img src="${dynamicAvatar}" class="${ringClass}"
               style="width:36px; height:36px; border-radius:12px; object-fit:cover;">
          ${u.status === 'online' ? '<span style="position:absolute; bottom:2px; right:2px; width:10px; height:10px; background:#22c55e; border-radius:50%; border:2px solid #0f172a;"></span>' : ''}
        </div>
        <div style="display:flex; flex-direction:column;">
          <div style="display:flex; align-items:center;">
            <span style="font-weight:600;">${u.username || 'User'}</span>
            ${verifiedBadge}
          </div>
          <span class="last-seen-text">${u.status === 'online' ? 'Online' : (u.lastSeen ? timeSince(u.lastSeen) : 'Offline')}</span>
        </div>
      `;
      btn.onclick = () => openDirectMessage(uid, u.username || 'User', u.photo);
      list.appendChild(btn);
    });
  });
}
function loadNotes() {
  const bar = document.getElementById('notesBar');
  db.ref('notes').on('value', snap => {
    bar.innerHTML = '';
    snap.forEach(child => {
      const n = child.val();
      if(Date.now() - n.timestamp > 86400000) return; // 24h expiry
      
      const div = document.createElement('div');
      div.className = 'note-bubble';
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:5px;">
           <img src="${n.photo || 'https://ui-avatars.com/api/?background=random'}" class="note-avatar">
           <span style="font-weight:bold; font-size:0.7rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60px;">${n.name}</span>
        </div>
        <div style="font-size:0.7rem; margin-top:4px;">${n.text}</div>
      `;
      // Clicking a note opens DM
      div.onclick = () => openDirectMessage(child.key, n.name, n.photo);
      bar.appendChild(div);
    });
  });
}

function addNote() {
  const t = prompt("What's on your mind? (24h)");
  if(t) db.ref(`notes/${currentUser.uid}`).set({ 
    text: t, 
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    name: document.getElementById('miniName').innerText,
    photo: document.getElementById('miniProfilePic').src
  });
}

/* ================== CONTEXT MENU ACTIONS ================== */
document.addEventListener('click', () => document.getElementById('ctx-menu').style.display = 'none');


function editMessageAction() {
  if(!selectedMessage || selectedMessage.sender !== currentUser.uid) return alert("Only your messages.");
  const newText = prompt("Edit:", selectedMessage.text);
  if(newText) db.ref(`rooms/${currentRoom}/messages/${selectedMessage.id}`).update({ text: newText });
}

function pinMessageAction() {
  if(!selectedMessage) return;
  const newState = !selectedMessage.isPinned;
  db.ref(`rooms/${currentRoom}/messages/${selectedMessage.id}`).update({ isPinned: newState });
}

function startReplyAction() {
  if(!selectedMessage) return;
  replyToData = {
    id: selectedMessage.id,
    username: selectedMessage.username,
    text: selectedMessage.text || "[Image]"
  };
  document.getElementById('replyBar').classList.remove('hidden');
  document.getElementById('replyUser').innerText = replyToData.username;
  document.getElementById('replyText').innerText = replyToData.text;
}

function cancelReply() {
  replyToData = null;
  document.getElementById('replyBar').classList.add('hidden');
}

function scrollToMessage(id) {
  const el = document.getElementById(`msg-${id}`);
  if(el) {
    el.scrollIntoView({behavior: "smooth", block: "center"});
    el.style.border = "1px solid var(--primary)";
    setTimeout(() => el.style.border = "none", 1000);
  }
}

/* ================== EFFECTS & UPLOADS ================== */
function cycleNextEffect() {
  effectIndex = (effectIndex + 1) % EFFECTS.length;
  nextEffect = EFFECTS[effectIndex];
  const label = document.getElementById('effectLabel');
  const ind = document.getElementById('effectIndicator');
  
  if(nextEffect) {
    label.style.display = 'inline';
    label.innerText = nextEffect.toUpperCase();
    ind.style.color = nextEffect === 'fire' ? '#ef4444' : '#a855f7';
  } else {
    label.style.display = 'none';
    ind.style.color = 'var(--text-muted)';
  }
}

function handleFileUpload(type) {
  const file = document.getElementById('imageInput').files[0];
  if(!file) return;
  const ref = storage.ref(`uploads/${Date.now()}_${file.name}`);
  ref.put(file).then(() => ref.getDownloadURL().then(url => sendMessage(url)));
}

function uploadProfilePic() {
  const file = document.getElementById('profileUpload').files[0];
  if(!file) return;
  const ref = storage.ref(`avatars/${currentUser.uid}`);
  ref.put(file).then(() => ref.getDownloadURL().then(url => db.ref(`users/${currentUser.uid}`).update({ photo: url })));
}

function uploadWallpaper() {
  const file = document.getElementById('wallInput').files[0];
  if(!file) return;
  const ref = storage.ref(`wallpapers/${currentUser.uid}`);
  ref.put(file).then(() => ref.getDownloadURL().then(url => db.ref(`users/${currentUser.uid}`).update({ wallpaper: url })));
}

function resetWallpaper() {
  db.ref(`users/${currentUser.uid}`).update({ wallpaper: null });
}

function saveThemeColor(color) {
  db.ref(`users/${currentUser.uid}`).update({ themeColor: color });
}

/* ================== PREMIUM & ADMIN ================== */
function startPurchase() {
  if (!currentUser) return;
  db.ref("premiumRequests/" + currentUser.uid).set({
    email: currentUser.email,
    uid: currentUser.uid,
    status: "pending",
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
  alert("Premium request sent to Admin!");
}

function checkAdmin(uid) {
  // Replace with your actual UID to secure this client-side (backend rules recommended)
  db.ref(`users/${uid}/isAdmin`).once('value', snap => {
    if(snap.val() === true) {
      document.getElementById('adminPanel').classList.remove('hidden');
      loadPremiumRequests();
    }
  });
}

function loadPremiumRequests() {
  const list = document.getElementById('premiumRequestsList');
  db.ref("premiumRequests").on("value", snap => {
    list.innerHTML = "";
    if(!snap.exists()) { list.innerHTML = "<div style='font-size:0.8rem;color:grey;'>No pending requests</div>"; return; }
    
    snap.forEach(child => {
      const r = child.val();
      const div = document.createElement("div");
      div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.marginBottom = "10px"; div.style.background = "rgba(0,0,0,0.3)"; div.style.padding = "8px"; div.style.borderRadius = "8px";
      div.innerHTML = `
        <span style="font-size:0.85rem;">${r.email}</span> 
        <button onclick="approvePremium('${r.uid}')" style="background:var(--primary); border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-weight:bold;">Approve</button>
      `;
      list.appendChild(div);
    });
  });
}

function approvePremium(uid) {
  db.ref(`users/${uid}`).update({ isPremium: true });
  db.ref(`premiumRequests/${uid}`).remove();
  alert("User approved!");
}
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);

  let interval = seconds / 31536000;
  if (interval > 1) return Math.floor(interval) + " years ago";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + " months ago";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + " days ago";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + " hrs ago";
  interval = seconds / 60;
  if (interval > 1) return Math.floor(interval) + " min ago";
  return "Just now";
}
</script>
</body>
</html>
